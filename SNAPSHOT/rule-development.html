<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 at 2020-01-15 
 | Rendered using Apache Maven Fluido Skin 1.6
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20200115" />
    <meta http-equiv="Content-Language" content="en" />
    <title>antenna-documentation &#x2013; Rule development</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.6.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
      <script type="text/javascript" src="./js/apache-maven-fluido-1.6.min.js"></script>
      </head>
    <body class="topBarDisabled">
      <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><div id="bannerLeft"><h2>Antenna Documentation</h2>
</div>
</div>
        <div class="pull-right"></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2020-01-15<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.0.0-SNAPSHOT</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
<ul class="nav nav-list">
          <li class="nav-header">Overview</li>
    <li><a href="index.html" title="About"><span class="none"></span>About</a>  </li>
    <li><a href="getting-started.html" title="Getting started"><span class="none"></span>Getting started</a>  </li>
    <li><a href="how-to-use.html" title="How to use Antenna"><span class="icon-chevron-down"></span>How to use Antenna</a>
      <ul class="nav nav-list">
    <li><a href="antenna-cli/index.html" title="Command Line Interface"><span class="none"></span>Command Line Interface</a>  </li>
    <li><a href="antenna-gradle-plugin/index.html" title="Gradle Plugin"><span class="none"></span>Gradle Plugin</a>  </li>
    <li><a href="antenna-maven-plugin/index.html" title="Maven"><span class="none"></span>Maven</a>  </li>
      </ul>
  </li>
    <li><a href="troubleshooting.html" title="Troubleshooting"><span class="none"></span>Troubleshooting</a>  </li>
          <li class="nav-header">Development</li>
    <li><a href="how-to-configure.html" title="How to configure Antenna"><span class="icon-chevron-down"></span>How to configure Antenna</a>
      <ul class="nav nav-list">
    <li><a href="tool-configuration.html" title="Tool Configuration"><span class="none"></span>Tool Configuration</a>  </li>
    <li><a href="config-configuration.html" title="config.xml"><span class="none"></span>config.xml</a>  </li>
    <li><a href="workflow-configuration.html" title="Workflow Configuration"><span class="icon-chevron-down"></span>Workflow Configuration</a>
      <ul class="nav nav-list">
    <li><a href="analyzers/analyzers.html" title="Analyzers"><span class="none"></span>Analyzers</a>  </li>
    <li><a href="processors/processors.html" title="Processors"><span class="none"></span>Processors</a>  </li>
    <li><a href="generators/generators.html" title="Generators"><span class="none"></span>Generators</a>  </li>
    <li><a href="outputHandlers/outputHandlers.html" title="Output Handlers"><span class="none"></span>Output Handlers</a>  </li>
      </ul>
  </li>
      </ul>
  </li>
    <li><a href="dev-guide.html" title="Development Guide"><span class="none"></span>Development Guide</a>  </li>
  </ul>
          <hr />
          <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
  <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
              </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Rule development</h1>
<p>Several helpers are available to let you easily develop rules for the rule engine. To simplify basic setup, a  <a class="externalLink" href="https://github.com/eclipse/antenna/tree/master/example-projects/rules-test-development-project">test project</a> has been setup.</p>
<div class="section">
<div class="section">
<h3><a name="Basic_folder_structure"></a>Basic folder structure</h3>
<p>The rules folder which is included in a basic tool run must have the following basic structure:</p>

<div>
<div>
<pre class="source">rule-folder
&#x251c;&#x2500;&#x2500;&#x2500;policies.properties
&#x251c;&#x2500;&#x2500;&#x2500;policies.xml
&#x2514;&#x2500;&#x2500;&#x2500;rules
    &#x251c;&#x2500;&#x2500;&#x2500;FirstRule.drl
    &#x2514;&#x2500;&#x2500;&#x2500;SecondRule.drl
</pre></div></div>

<p>Therefore, it makes sense to mimic this structure inside the <tt>src/main/resources</tt> folder of your rule project.</p>
<p>In addition, you can add cucumber tests for your rules which will be explained below.</p>
<div class="section">
<h4><a name="The_policies.xml_file"></a>The policies.xml file</h4>
<p>The file <tt>policies.properties</tt> contains the policy evaluations which are used by the rules.</p>
<p>An example for a policy evaluation can look like:</p>

<div>
<div>
<pre class="source">&lt;policies&gt;
    &lt;policy&gt;
        &lt;id&gt;Dummy&lt;/id&gt;
        &lt;description&gt;Dummy A1 Policy&lt;/description&gt;
        &lt;severity&gt;FAIL&lt;/severity&gt;
    &lt;/policy&gt;
&lt;/policies&gt;
</pre></div></div>

<p>Additional policy evaluation can be added using further <tt>&lt;policy&gt;&lt;/policy&gt;</tt> tags.</p>
<ul>

<li><tt>id</tt> defines the reference for the policy. It must be unique across all policies as it is used in rule files to attach failed artifacts.</li>
<li><tt>description</tt> is a description of the policy which will be displayed when artifacts fail a rule.</li>
<li><tt>severity</tt>, one of (i.e. <b>FAIL</b>, <b>WARN</b> or <b>INFO</b>).</li>
</ul>
<p><b>NOTE:</b> The policy id will be mapped by the rule, but a rule without policy will not get executed. There will be no warning. This is a limitation of the Drools-Engine as currently implemented. The only way to ensure that all rules have correct associated policy ids is to write tests for the rules.</p></div>
<div class="section">
<h4><a name="The_policies.properties_file"></a>The policies.properties file</h4>
<p>The file <tt>policies.properties</tt> must contain two properties:</p>
<ul>

<li><tt>policies.name</tt>: a name for the set of properties. This makes distinguishing several folders easy.</li>
<li><tt>policies.version</tt>: a version string. This can be any string and should be updated when changing the set of rules. The <tt>policies.name</tt> and the <tt>policies.version</tt> are logged in the execution of the drools checker and therefore provide traceability.</li>
</ul></div></div>
<div class="section">
<h3><a name="Writing_rules"></a>Writing rules</h3>
<p>Rules are written as <a class="externalLink" href="https://www.drools.org/">Drools rules</a>. This way, rules have access to the complete <tt>Artifact</tt> model defined in <tt>antenna-model</tt>. To make access more convenient, helper functions are provided in <tt>antenna-drools-checker</tt> in the file <tt>DroolsRulesUtils.java</tt>. These helper functions will increase in functionality over time.</p>
<p>Every rule should have a basic similar structure:</p>

<div>
<div>
<pre class="source">rule &quot;Some rule&quot;
no-loop true
when
    a : Artifact(...)
    e : DroolsEvaluationResult( getId() == &quot;SomeId&quot; )
then
    modify (e) { addFailedArtifact(a) };
end
</pre></div></div>

<p>Taking one or more artifacts and an ID for a policy evaluation, add any artifact that fails the rule to the policy evaluation result. The <tt>getId()</tt> must match an existing policy in the <tt>policy.xml</tt> file. Note that the ID must exist (this is not checked at runtime but should be checked by your tests anyway).</p></div>
<div class="section">
<h3><a name="Writing_tests_for_rules"></a>Writing tests for rules</h3>
<p>A testing harness for <a class="externalLink" href="https://cucumber.io/">Cucumber</a> tests is in place. To use it you must first add the dependencies to your parent pom (see the full <tt>pom.xml</tt> in the test project for an example). In addition, you need to add the dependency on <tt>antenna-rule-engine-testing</tt>.</p>
<p>Furthermore, in <tt>src/test</tt>, add the following files into a package <tt>org.eclipse.sw360.antenna.droolstesting</tt>:</p>
<ul>

<li><tt>AddRulesAndEvaluations.java</tt>, containing the following code:</li>
</ul>

<div>
<div>
<pre class="source">package org.eclipse.sw360.antenna.droolstesting;

import cucumber.api.java.en.When;

import java.io.FileNotFoundException;
import java.net.URISyntaxException;

public class AddRulesAndEvaluations {
    private WhenStepsHelpers stepsHelpers;

    public AddRulesAndEvaluations(ScenarioState state) {
        this.stepsHelpers = new WhenStepsHelpers(state);
    }

    @When(&quot;^I use the rule \&quot;([^\&quot;]*)\&quot;$&quot;)
    public void i_use_the_rule(String rule) throws FileNotFoundException, URISyntaxException {
        stepsHelpers.iUseTheRule(rule, this.getClass());
    }
}
</pre></div></div>

<p>This code allows your cucumber features to find your test features. * <tt>RunCucumberTest.java</tt>, containing the following code:</p>

<div>
<div>
<pre class="source">package org.eclipse.sw360.antenna.droolstesting;

import cucumber.api.CucumberOptions;
import cucumber.api.junit.Cucumber;
import org.junit.runner.RunWith;

@RunWith(Cucumber.class)
@CucumberOptions(
        features = &quot;src/test/resources/tests/&quot;,
        glue = &quot;org.eclipse.sw360.antenna.droolstesting&quot;
)
public class RunCucumberTest {
    // nothing to do, this is just a wrapper to execute the tests
}
</pre></div></div>

<p>You can adapt the path to <tt>features</tt> to where your feature tests are located. To be more concrete, this will allow running all tests automatically if the folder structure looks like this:</p>

<div>
<div>
<pre class="source">src
&#x251c;&#x2500;&#x2500;&#x2500;main
&#x2502;   &#x2514;&#x2500;&#x2500;&#x2500;resources
&#x2502;       &#x2514;&#x2500;&#x2500;&#x2500;policies
&#x2502;           &#x251c;&#x2500;&#x2500;&#x2500;policies.properties
&#x2502;           &#x251c;&#x2500;&#x2500;&#x2500;policies.xml
&#x2502;           &#x2514;&#x2500;&#x2500;&#x2500;rules
&#x2502;               &#x251c;&#x2500;&#x2500;&#x2500;FirstRule.drl
&#x2502;               &#x2514;&#x2500;&#x2500;&#x2500;SecondRule.drl
&#x2514;&#x2500;&#x2500;&#x2500;test
    &#x251c;&#x2500;&#x2500;&#x2500;java
    &#x2502;   &#x2514;&#x2500;&#x2500;&#x2500;org.eclipse.sw360.antenna.droolstesting
    &#x2502;       &#x251c;&#x2500;&#x2500;&#x2500;AddRulesAndEvaluations.java
    &#x2502;       &#x2514;&#x2500;&#x2500;&#x2500;RunCucumberTest.java
    &#x2514;&#x2500;&#x2500;&#x2500;resources
        &#x2514;&#x2500;&#x2500;&#x2500;tests
            &#x2514;&#x2500;&#x2500;&#x2500;RuleTest.feature
</pre></div></div>

<p>If you want to develop your rules with maven, the surefire-maven plugin must be made aware of the tests by adding:</p>

<div>
<div>
<pre class="source">    &lt;build&gt;
        &lt;testResources&gt;
            &lt;testResource&gt;
                &lt;directory&gt;src/resources&lt;/directory&gt;
            &lt;/testResource&gt;
        &lt;/testResources&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.22.0&lt;/version&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;
</pre></div></div>

<div class="section">
<h4><a name="Built_in_functionality_for_testing"></a>Built in functionality for testing</h4>
<p>Cucumber tests are called &#x201c;Features&#x201d; and divided into &#x201c;Scenarios&#x201d;. Each step is divided into &#x201c;Given&#x201d;, &#x201c;When&#x201d;, &#x201c;Then&#x201d; steps (see the <a class="externalLink" href="https://cucumber.io">official documentation</a>)).</p>
<p>The following steps are available to you (this will be enhanced in the future):</p>
<div class="section">
<h5><a name="Given_steps"></a>Given steps</h5>
<ul>

<li><tt>Given an artifact with</tt>: Create an artifact with data given by the data table following the <tt>Given</tt> line. This should be used if only one artifact is needed for the scenario.</li>
<li><tt>Given an artifact called &quot;MyArtifact&quot; with</tt>: Create an artifact with data given by the data table following the <tt>Given</tt> line. This will internally give the artifact a name (&#x201c;MyArtifact&#x201d;), which makes it identifiable in the <tt>Then</tt>-step. This should be used if several artifacts are given in the same scenario.</li>
</ul>
<p>Note that several artifacts can be given by chainging with <tt>And</tt>, e.g. calling <tt>And an artifact called &quot;MyArtifact2&quot; with</tt></p>
<p>The configuration of artifacts happens in a data table which is described below.</p></div>
<div class="section">
<h5><a name="When_steps"></a>When steps</h5>
<ul>

<li><tt>When I use the rule &quot;SomeRule&quot;</tt>: run the rule in the file <tt>SomeRule.drl</tt>. Currently, only one rule at a time can be tested.</li>
</ul></div>
<div class="section">
<h5><a name="Then_steps"></a>Then steps</h5>
<ul>

<li><tt>Then the artifact should fail with policy id &quot;SomeId&quot;</tt>: This should only be used if there is one artifact. It will pass the test if the artifact was added to an evaluation result with id &#x201c;SomeId&#x201d;, where the evaluation result lies in the <tt>policies.xml</tt> file.</li>
<li><tt>Then all artifacts fail with policy id &quot;SomeId&quot;</tt>: This can be used for multiple artifacts in the scenario. It will pass the test if all artifacts are listed as failures in an evaluation result with id &#x201c;SomeId&#x201d;.</li>
<li><tt>Then no artifact fails</tt>: Passes the test if no artifact fails any policy id.</li>
<li><tt>Then the artifact called &quot;MyArtifact&quot; should fail with policy id &quot;SomeId&quot;</tt>: This can be used when multiple artifacts are present but not all should fail. It will pass the test if the artifact with name &#x201c;MyArtifact&#x201d; (as given in the &#x201c;Given&#x201d; step of the same scenario) will be listed as a failure.</li>
</ul></div></div>
<div class="section">
<h4><a name="The_artifact_data_table"></a>The artifact data table</h4>
<p>A data table to configure an artifact has a variable number of rows and columns. However, each artifact data table must have the same number of columns for each row. The following row entries can be configured (see also the <tt>Mappings.java</tt> file inside <tt>antenna-rule-engine-testing</tt>:</p>
<ul>

<li><tt>properietary</tt>: The second column can be either <tt>true</tt> or <tt>false</tt>. This will mark the artifact as proprietary (or not).</li>
<li><tt>matchstate</tt>: The second column can be <tt>exact</tt>, <tt>unknown</tt> or <tt>similar</tt> matching the ArtifactMatchState.</li>
<li><tt>license</tt>: Add a license to the artifact. The license field comes with several additional configuration possibilities:
<ul>

<li>The second column denotes the name of the license</li>
<li>The third column can be one of <tt>Declared</tt>, <tt>Observed</tt>, <tt>Overridden</tt> or <tt>Configured</tt> matching the phase where the license was found. Configured licenses are the strongest corresponding to declaration in the <tt>antennaconf.xml</tt> (for example).</li>
<li>The fourth column can be a license threat-group, e.g. <tt>unknown</tt> or <tt>strict copyleft</tt>.</li>
</ul>
</li>
<li><tt>licenseAlternatives</tt>: Add a compound license to the artifact. The second column is the name of the compound license, which consists of two license names connected by either <tt>OR</tt> or <tt>AND</tt>.</li>
<li><tt>coordinates</tt>: This adds coordinates to the artifact. The following columns can be specified:
<ul>

<li>The second column denotes the type of coordinates, currently either <tt>maven</tt>, <tt>bundle</tt>, <tt>dotnet</tt>, <tt>javascript</tt> or <tt>generic</tt>.</li>
<li>Depending on the type of coordinates, the next columns specify artifact ids and version or similar coordinates in descending order of generality, where the last column is the version string. For example, maven coordinates have three additional fields groupId, artifactId and version. Coordinates may contain wildcards <tt>*</tt> for words.</li>
</ul>
</li>
<li><tt>securityIssue</tt>: This adds a security issue to the artifact:
<ul>

<li>The second column is the type of issue (e.g. <tt>acknowledged</tt>, <tt>confirmed</tt>, <tt>not applicable</tt> or <tt>open</tt>).</li>
<li>The third column adds the security level (it must be a dot-separated double).</li>
</ul>
</li>
</ul>
<p>To give an example, here is a valid setup for an artifact:</p>

<div>
<div>
<pre class="source">Given an artifact with
      | license       | EPL-2.0 | Declared      | liberal |   |
      | coordinates   | maven   | org.eclipse.* | *       | * |
      | matchstate    | similar |               |         |   |
      | securityIssue | open    | 6.1           |         |   |
</pre></div></div>

<p>This will configure an artifact with an EPL-2.0 license (Declared), matchstate &#x201c;similar&#x201d; one open security issue of severity 6.1 and maven coordinates starting with groupId starting with &#x201c;org.eclipse&#x201d;</p></div></div></div>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2020.
All rights reserved.</p>
        </div>
        </div>
    </footer>
    </body>
</html>
